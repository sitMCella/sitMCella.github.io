<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/x-icon"><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"><meta content="#000000" name="theme-color"><meta content="Marco Cella Blog" name="description"><link href="/manifest.json" rel="manifest"><link href="/logo192.png" rel="apple-touch-icon"><title>Prometheus Scrape Metrics</title><style>@import url(https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap);</style><script type="text/javascript">!function(n){if("/"===n.search[1]){var a=n.search.slice(1).split("&").map(function(n){return n.replace(/~and~/g,"&")}).join("?");window.history.replaceState(null,null,n.pathname.slice(0,-1)+a+n.hash)}}(window.location)</script><script defer src="/static/js/main.88814732.js"></script><link href="/static/css/main.6284e917.css" rel="stylesheet"><link href="https://fonts.googleapis.com" rel="preconnect"><meta content="Prometheus Scrape Metrics" data-react-helmet="true" name="description"><meta content="azure, kubernetes, prometheus" data-react-helmet="true" name="keywords"><meta content="Marco Cella" data-react-helmet="true" name="author"><meta content="Prometheus Scrape Metrics" data-react-helmet="true" property="og:title"><meta content="Prometheus Scrape Metrics" data-react-helmet="true" property="og:description"><meta content="website" data-react-helmet="true" property="og:type"><link href="https://fonts.gstatic.com" rel="preconnect"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="App"><div class="light"><div><nav class="sticky top-0 bg-gray-custom1 dark:bg-slate-custom3 flex justify-center"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0 flex justify-left header"><div class="my-4"><span class="text-5xl font-extrabold text-gray-900 dark:text-white1 m-2">mc //connected</span></div><div class="line-break"></div><div class="w-full min-w-full"><div class="float-left"><a href="/blog" data-discover="true"><button type="button" class="text-gray-900 focus:outline-none border-none hover:bg-gray-100 focus:bg-gray-100 font-medium rounded-full text-sm lg:text-base px-3 py-1.5 me-2 mb-2 dark:border-gray-100 dark:hover:bg-gray-100 dark:hover:border-gray-100 dark:text-gray-100 hover:dark:text-gray-900 dark:bg-slate-custom2 false">Blog</button></a><a href="/profile" data-discover="true"><button type="button" class="text-gray-900 focus:outline-none border-none hover:bg-gray-100 focus:bg-gray-100 font-medium rounded-full text-sm lg:text-base px-3 py-1.5 me-2 mb-2 dark:border-gray-100 dark:hover:bg-gray-100 dark:hover:border-gray-100 dark:text-gray-100 hover:dark:text-gray-900 dark:bg-slate-custom2 false">Profile</button></a></div><div class="flex float-right h-full items-center text-gray-900 dark:text-gray-100"><button type="button"><svg class="size-5 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></div></div></div></nav></div><div class="flex flex-col items-center content min-h-[calc(100vh-172px)] dark:bg-slate-custom1"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0"><div class="mt-16 mb-4 flex justify-items-start content"><h1 class="font-semibold text-left text-lg lg:text-2xl w-full md:w-full dark:text-gray-custom1">Prometheus Scrape Metrics</h1><div class="line-break"></div><span class="flex items-center"><svg class="h-6 w-6 stroke-orange-400 mr-2 text-gray-custom3 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-slot="icon"><path d="M6.75 2.994v2.25m10.5-2.25v2.25m-14.252 13.5V7.491a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v11.251m-18 0a2.25 2.25 0 0 0 2.25 2.25h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5m-6.75-6h2.25m-9 2.25h4.5m.002-2.25h.005v.006H12v-.006Zm-.001 4.5h.006v.006h-.006v-.005Zm-2.25.001h.005v.006H9.75v-.006Zm-2.25 0h.005v.005h-.006v-.005Zm6.75-2.247h.005v.005h-.005v-.005Zm0 2.247h.006v.006h-.006v-.006Zm2.25-2.248h.006V15H16.5v-.005Z" stroke-linecap="round" stroke-linejoin="round"></path></svg><time class="text-gray-custom2 text-left text-sm lg:text-base w-full md:w-full dark:text-gray-custom4">Mar 22, 2025</time></span><div class="line-break"></div><div class="articleBody"><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Prometheus is a monitoring and alerting toolkit designed to collect, process, and store metrics as time series data, playing a crucial role in infrastructure observability. Prometheus consists of multiple components, but in this article, I will focus on its metrics scraping functionality.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Prometheus collects metrics from instrumented jobs using a pull-based model, either directly or through an intermediary push gateway for short-lived jobs. To enable this, applications must expose an http(s) endpoint containing metrics in Prometheus format. Prometheus then periodically scrapes these endpoints to gather and store the metrics.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">I will describe three different approaches for configuring Prometheus to scrape metrics, using Kubernetes Helm Charts deployed in one Azure Kubernetes Service resource.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The GitHub repository of the project is the following:<br><a href="https://github.com/sitMCella/prometheus-metrics" class="underline" rel="noreferrer" target="_blank">sitMCella/prometheus-metrics</a></p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The project provides one Helm Chart with name "metrics", with two dependencies: Kube Prometheus Stack and Grafana Tempo.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Kube Prometheus Stack [1] is an Helm Chart pre-packaged with many different components, such as Prometheus, Prometheus Operator, and Alert Manager.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">For all three scenarios, Grafana Tempo is used as the example application instrumented to send metrics to Prometheus. In this project I used the Tempo deployment in monolithic mode [2]. It's important to notice that Kube Prometheus Stack is pre-configured to collect metrics from all Kubernetes components, so the Prometheus Targets page will contain many other instances alongside Grafana Tempo.</p><p class="font-semibold leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">ServiceMonitor</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Prometheus Operator [3] is a Kubernetes Operator that provides Kubernetes native deployment and management of Prometheus and related monitoring components. The Prometheus Operator provides a set of Custom Resource Definitions (CRDs) to simplify the target configuration in Kubernetes, reducing the need for manual Prometheus configuration. Specifically, the ServiceMonitor CRD is used to define which services should be scraped for metrics within Kubernetes.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">In order for Prometheus Operator to scrape a target, the ServiceMonitor resource must be configured with the matching label defined in Prometheus.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Run the following command to verify the label applied in Prometheus:</p><pre class="mt-4 text-left h-68 w-full language-bash" tabindex="0"><code class="language-bash">kubectl describe prometheus/metrics-kube-prometheus-st-prometheus <span class="token parameter variable">-n</span> metrics</code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The Prometheus Operator is configured with:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">Service Monitor Selector</span><span class="token punctuation">:</span>
  Match Labels<span class="token punctuation">:</span>
    Release<span class="token punctuation">:</span> metrics</code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Within the ServiceMonitor resource you need to specify the Kubernetes labels that the Prometheus Operator can use to identify the Kubernetes Service which in turn identifies the Pods of the application to monitor. The Grafana Tempo Helm Chart is configured with the ServiceMonitor resource for the Tempo service, so you just need to specify the matching label for instructing Prometheus to scrape the target.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The following is the configuration applied to Grafana Tempo:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">tempo</span><span class="token punctuation">:</span>
  serviceMonitor<span class="token punctuation">:</span>
    enabled<span class="token punctuation">:</span> <span class="token boolean important">true</span>
    interval<span class="token punctuation">:</span> 15s
    additionalLabels<span class="token punctuation">:</span>
      release<span class="token punctuation">:</span> metrics
    annotations<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p class="font-semibold leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Additional Scrape Configs</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The second approach is to configure PrometheusSpec in the Kube Prometheus Stack with additional scrape configurations:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">kube-prometheus-stack</span><span class="token punctuation">:</span>
  prometheus<span class="token punctuation">:</span>
    prometheusSpec<span class="token punctuation">:</span>
      additionalScrapeConfigs<span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'grafana-tempo-additional'</span>
          scrape_interval<span class="token punctuation">:</span> 15s
          static_configs<span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'grafana-tempo.metrics.svc.cluster.local:3100'</span><span class="token punctuation">]</span></code></pre><p class="font-semibold leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">ScrapeConfig</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The Prometheus Operator provides also the ScrapeConfig custom resource. This approach is commonly used to scrape targets external to the Kubernetes cluster that are not discoverable via ServiceMonitor or PodMonitor.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The scrapeConfigSelector field in the Prometheus resource must be configured with a set of label selectors that match the labels applied to the ScrapeConfig resources.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">In the project, Prometheus has been configured as follows:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">kube-prometheus-stack</span><span class="token punctuation">:</span>
  prometheus<span class="token punctuation">:</span>
    prometheusSpec<span class="token punctuation">:</span>
    scrapeConfigSelector<span class="token punctuation">:</span>
      matchLabels<span class="token punctuation">:</span>
        prometheus<span class="token punctuation">:</span> monitoring<span class="token punctuation">-</span>prometheus</code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The following are the parameters applied to the ScrapeConfig resource:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">global</span><span class="token punctuation">:</span>
  scrapeconfig<span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token string">"grafana-tempo"</span>
    labels<span class="token punctuation">:</span>
      prometheus<span class="token punctuation">:</span> monitoring<span class="token punctuation">-</span>prometheus
    spec<span class="token punctuation">:</span>
      staticConfigs<span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'grafana-tempo.metrics.svc.cluster.local:3100'</span><span class="token punctuation">]</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The Grafana Tempo Helm Chart does not provide the template for the ScrapeConfig resource, so this template has been added as part of the "metrics" Helm Chart.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Prometheus attaches the labels "job" and "instance" automatically to the scraped time series which serve to identify the target. In addition to the default labels, the example configurations add the label "cluster" with value "aks" to the scraped time series.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">[1] <a href="https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack" class="underline" rel="noreferrer" target="_blank">kube-prometheus-stack</a><br>[2] <a href="https://artifacthub.io/packages/helm/grafana/tempo" class="underline" rel="noreferrer" target="_blank">grafana/tempo</a><br>[3] <a href="https://prometheus-operator.dev" class="underline" rel="noreferrer" target="_blank">prometheus-operator</a></p></div></div><div class="mt-8 flex items-center text-left"><svg class="h-5 w-5 stroke-orange-400 mr-1 text-gray-custom3 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-slot="icon"><path d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6 6h.008v.008H6V6Z" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">azure</span><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">kubernetes</span><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">prometheus</span></div></div><div class="mb-16"></div><div></div></div><div><nav class="sticky top-0 bg-gray-custom1 dark:bg-slate-custom3 flex justify-center"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0 flex justify-left header"><div class="w-full min-w-full"><div class="float-left"><div class="my-4"><span><span class="text-gray-900 dark:text-white1 tracking-wide text-sm lg:text-base">© Marco Cella • all rights reserved</span></span></div></div><div class="flex float-right h-full items-center text-gray-900 dark:text-gray-100"><a href="https://www.linkedin.com/in/marco-cella-48391a5b" class="underline mr-2" rel="noreferrer" target="_blank"><svg class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" stroke-linecap="round" stroke-linejoin="round" width="24"><path d="M0 0h24v24H0z" fill="none" stroke="none"></path><path d="M8 11v5"></path><path d="M8 8v.01"></path><path d="M12 16v-5"></path><path d="M16 16v-3a2 2 0 1 0 -4 0"></path><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z"></path></svg></a><a href="https://mastodon.social/@marco_cella" class="underline" rel="noreferrer" target="_blank"><svg class="icon icon-tabler icons-tabler-outline icon-tabler-brand-mastodon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" stroke-linecap="round" stroke-linejoin="round" width="24"><path d="M0 0h24v24H0z" fill="none" stroke="none"></path><path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z"></path><path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722"></path></svg></a></div></div></div></nav></div></div></div></div></body></html>