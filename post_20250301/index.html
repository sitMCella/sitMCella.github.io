<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/x-icon"><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"><meta content="#000000" name="theme-color"><meta content="Marco Cella Blog" name="description"><link href="/manifest.json" rel="manifest"><link href="/logo192.png" rel="apple-touch-icon"><title>Telemetry Traces with Grafana Tempo</title><style>@import url(https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap);</style><script type="text/javascript">!function(n){if("/"===n.search[1]){var a=n.search.slice(1).split("&").map(function(n){return n.replace(/~and~/g,"&")}).join("?");window.history.replaceState(null,null,n.pathname.slice(0,-1)+a+n.hash)}}(window.location)</script><script defer src="/static/js/main.88814732.js"></script><link href="/static/css/main.6284e917.css" rel="stylesheet"><link href="https://fonts.googleapis.com" rel="preconnect"><meta content="Telemetry Traces with Grafana Tempo" data-react-helmet="true" name="description"><meta content="azure, kubernetes, opentelemetry, grafana" data-react-helmet="true" name="keywords"><meta content="Marco Cella" data-react-helmet="true" name="author"><meta content="Telemetry Traces with Grafana Tempo" data-react-helmet="true" property="og:title"><meta content="Telemetry Traces with Grafana Tempo" data-react-helmet="true" property="og:description"><meta content="website" data-react-helmet="true" property="og:type"><link href="https://fonts.gstatic.com" rel="preconnect"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="App"><div class="light"><div><nav class="sticky top-0 bg-gray-custom1 dark:bg-slate-custom3 flex justify-center"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0 flex justify-left header"><div class="my-4"><span class="text-5xl font-extrabold text-gray-900 dark:text-white1 m-2">mc //connected</span></div><div class="line-break"></div><div class="w-full min-w-full"><div class="float-left"><a href="/blog" data-discover="true"><button type="button" class="text-gray-900 focus:outline-none border-none hover:bg-gray-100 focus:bg-gray-100 font-medium rounded-full text-sm lg:text-base px-3 py-1.5 me-2 mb-2 dark:border-gray-100 dark:hover:bg-gray-100 dark:hover:border-gray-100 dark:text-gray-100 hover:dark:text-gray-900 dark:bg-slate-custom2 false">Blog</button></a><a href="/profile" data-discover="true"><button type="button" class="text-gray-900 focus:outline-none border-none hover:bg-gray-100 focus:bg-gray-100 font-medium rounded-full text-sm lg:text-base px-3 py-1.5 me-2 mb-2 dark:border-gray-100 dark:hover:bg-gray-100 dark:hover:border-gray-100 dark:text-gray-100 hover:dark:text-gray-900 dark:bg-slate-custom2 false">Profile</button></a></div><div class="flex float-right h-full items-center text-gray-900 dark:text-gray-100"><button type="button"><svg class="size-5 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></div></div></div></nav></div><div class="flex flex-col items-center content min-h-[calc(100vh-172px)] dark:bg-slate-custom1"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0"><div class="mt-16 mb-4 flex justify-items-start content"><h1 class="font-semibold text-left text-lg lg:text-2xl w-full md:w-full dark:text-gray-custom1">Telemetry Traces with Grafana Tempo</h1><div class="line-break"></div><span class="flex items-center"><svg class="h-6 w-6 stroke-orange-400 mr-2 text-gray-custom3 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-slot="icon"><path d="M6.75 2.994v2.25m10.5-2.25v2.25m-14.252 13.5V7.491a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v11.251m-18 0a2.25 2.25 0 0 0 2.25 2.25h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5m-6.75-6h2.25m-9 2.25h4.5m.002-2.25h.005v.006H12v-.006Zm-.001 4.5h.006v.006h-.006v-.005Zm-2.25.001h.005v.006H9.75v-.006Zm-2.25 0h.005v.005h-.006v-.005Zm6.75-2.247h.005v.005h-.005v-.005Zm0 2.247h.006v.006h-.006v-.006Zm2.25-2.248h.006V15H16.5v-.005Z" stroke-linecap="round" stroke-linejoin="round"></path></svg><time class="text-gray-custom2 text-left text-sm lg:text-base w-full md:w-full dark:text-gray-custom4">Mar 1, 2025</time></span><div class="line-break"></div><div class="articleBody"><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Infrastructure observability is becoming essential with the increasing complexity of the applications, developed using microservices or serverless architectures, and provisioned on distributed systems managed by cloud providers and orchestration platforms such as Kubernetes.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">OpenTelemetry is an observability framework designed to manage telemetry data such as traces, metrics, and logs [1]. OpenTelemetry is not an observability backend like Prometheus, instead focuses on the generation, collection, management, and export of telemetry data. OpenTelemetry provides libraries for different programming languages for instrumenting the application to emit signals. The applications send the telemetry data to a backend that processes and stores the signals.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">OpenTelemetry Collector [2] is a proxy that can receive, process, and export telemetry data. It supports receiving telemetry data in multiple formats (for example OTLP, Jaeger, and Prometheus), and sending data to one or more backends. It also supports processing and filtering telemetry data before it gets exported.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Grafana Tempo [3] is a distributed tracing backend, that can ingest common open source tracing protocols, including Jaeger, Zipkin, and OpenTelemetry. Grafana Tempo requires just an object storage to operate, used for the long term storage of the traces. Grafana Tempo does not index the traces, in order to provide a scalable and cost-effective solution.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Grafana [4] is a platform used to query and visualise metrics, logs, and traces. Grafana natively supports Grafana Tempo providing the built-in Tempo data source.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">I created a project that showcases the usage of these frameworks hosted in one Azure Kubernetes Service resource. The high level design of the solution is the following: a Python application, instrumented with the OpenTelemetry library, sends the telemetry data to OpenTelemetry Collector configured with the OTLP receiver. OpenTelemetry Collector dispatches the traces to Grafana Tempo using the OTLP receiver. Grafana Tempo stores the traces in one Azure Storage Account. To complete the configuration, a Tempo data source can be created in Grafana to connect to Grafana Tempo and visualise the traces.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The GitHub repository of the project is the following:<br><a href="https://github.com/sitMCella/opentelemetry-traces-grafana-tempo" class="underline" rel="noreferrer" target="_blank">sitMCella/opentelemetry-traces-grafana-tempo</a></p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">OpenTelemetry Collector, Grafana Tempo, and Grafana are configured and deployed in Kubernetes using the following Helm Charts:<br><a href="https://artifacthub.io/packages/helm/opentelemetry-helm/opentelemetry-collector" class="underline" rel="noreferrer" target="_blank">opentelemetry-helm/opentelemetry-collector</a><br><a href="https://artifacthub.io/packages/helm/grafana/tempo-distributed" class="underline" rel="noreferrer" target="_blank">grafana/tempo-distributed</a><br><a href="https://artifacthub.io/packages/helm/grafana/grafana" class="underline" rel="noreferrer" target="_blank">grafana/grafana</a></p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Grafana Tempo can be either deployed in monolithic mode or in microservices mode. Grafana Tempo distributed uses the microservices deployment mode, and consists of different components: ingestor, distributor, compactor, querier, query frontend, and memcache.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">As described in the Grafana Tempo documentation [5], you can use different approaches for granting Grafana Tempo access to an Azure Storage Account: the Storage Account access key, an Azure Managed Identity, or via Azure Workload Identity.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The project makes use of the Azure Workload Identity, allowing the Grafana Tempo pods to connect to the Azure Storage Account. Using the Workload Identity federation [6], the application makes use of trusted tokens to access the Microsoft Entra protected resources. The design of the solution is following.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The Azure Kubernetes Service resource is configured with Azure Workload Identity and OIDC issuer:</p><pre class="mt-4 text-left h-68 w-full language-javascript" tabindex="0"><code class="language-javascript">resource <span class="token string">"azurerm_kubernetes_cluster"</span> <span class="token string">"aks"</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
  oidc_issuer_enabled <span class="token operator">=</span> <span class="token boolean">true</span>
  workload_identity_enabled <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The RBAC role "Storage Blob Data Contributor" is granted to the User Managed Identity on the Azure Storage Account.<br>The Grafana Tempo Helm Chart is configured with a service account connected to the User Managed Identity:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span>
  create<span class="token punctuation">:</span> <span class="token boolean important">true</span>
  name<span class="token punctuation">:</span> <span class="token string">"tempo-service-account"</span>
  annotations<span class="token punctuation">:</span>
    azure.workload.identity/client<span class="token punctuation">-</span><span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token string">"value"</span>
    azure.workload.identity/tenant<span class="token punctuation">-</span><span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token string">"value"</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The following label is applied to the Tempo pods in the Grafana Tempo Helm Chart:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">tempo</span><span class="token punctuation">:</span>
  podLabels<span class="token punctuation">:</span>
    azure.workload.identity/use<span class="token punctuation">:</span> <span class="token string">"true"</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The storage backend in the Grafana Tempo Helm Chart is configured with the Azure Storage Account name and the container name where the traces are going to be stored:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">storage</span><span class="token punctuation">:</span>
  trace<span class="token punctuation">:</span>
    backend<span class="token punctuation">:</span> azure
    azure<span class="token punctuation">:</span>
      container_name<span class="token punctuation">:</span> <span class="token string">"traces"</span>
      storage_account_name<span class="token punctuation">:</span> <span class="token string">"value"</span>
      use_federated_token<span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">A federated identity credentials resource in Azure establishes a trust relationship between the Azure Kubernetes Service, the User Managed Identity, and the service account deployed in Kubernetes.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The Helm Charts in the project are configured for a simple test scenario. Specifically, the Grafana Tempo components are configured with one single replica. It's interesting to notice that with the default configuration in place, Grafana Tempo distributor throws the following error:</p><p class="bg-blue-100 dark:bg-blue-900 border-blue-500 text-blue-700 dark:text-blue-100 leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert px-4 py-2">msg="pusher failed to consume trace data" err="at least 2 live replicas required, could only find 1"</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The following configuration must then be applied in the Grafana Tempo Helm Chart:</p><pre class="mt-4 text-left h-68 w-full language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">ingester</span><span class="token punctuation">:</span>
  config<span class="token punctuation">:</span>
    replication_factor<span class="token punctuation">:</span> <span class="token number">1</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">[1] <a href="https://opentelemetry.io/docs/what-is-opentelemetry/" class="underline" rel="noreferrer" target="_blank">opentelemetry</a><br>[2] <a href="https://opentelemetry.io/docs/collector/" class="underline" rel="noreferrer" target="_blank">opentelemetry-collector</a><br>[3] <a href="https://grafana.com/oss/tempo/" class="underline" rel="noreferrer" target="_blank">grafana-tempo</a><br>[4] <a href="https://grafana.com/" class="underline" rel="noreferrer" target="_blank">grafana</a><br>[5] <a href="https://grafana.com/docs/tempo/latest/configuration/hosted-storage/azure/" class="underline" rel="noreferrer" target="_blank">grafana-tempo-storage</a><br>[6] <a href="https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation" class="underline" rel="noreferrer" target="_blank">workload-identity-federation</a></p></div></div><div class="mt-8 flex items-center text-left"><svg class="h-5 w-5 stroke-orange-400 mr-1 text-gray-custom3 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-slot="icon"><path d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6 6h.008v.008H6V6Z" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">azure</span><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">kubernetes</span><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">opentelemetry</span><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">grafana</span></div></div><div class="mb-16"></div><div></div></div><div><nav class="sticky top-0 bg-gray-custom1 dark:bg-slate-custom3 flex justify-center"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0 flex justify-left header"><div class="w-full min-w-full"><div class="float-left"><div class="my-4"><span><span class="text-gray-900 dark:text-white1 tracking-wide text-sm lg:text-base">© Marco Cella • all rights reserved</span></span></div></div><div class="flex float-right h-full items-center text-gray-900 dark:text-gray-100"><a href="https://www.linkedin.com/in/marco-cella-48391a5b" class="underline mr-2" rel="noreferrer" target="_blank"><svg class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" stroke-linecap="round" stroke-linejoin="round" width="24"><path d="M0 0h24v24H0z" fill="none" stroke="none"></path><path d="M8 11v5"></path><path d="M8 8v.01"></path><path d="M12 16v-5"></path><path d="M16 16v-3a2 2 0 1 0 -4 0"></path><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z"></path></svg></a><a href="https://mastodon.social/@marco_cella" class="underline" rel="noreferrer" target="_blank"><svg class="icon icon-tabler icons-tabler-outline icon-tabler-brand-mastodon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" stroke-linecap="round" stroke-linejoin="round" width="24"><path d="M0 0h24v24H0z" fill="none" stroke="none"></path><path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z"></path><path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722"></path></svg></a></div></div></div></nav></div></div></div></div></body></html>