<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/x-icon"><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"><meta content="#000000" name="theme-color"><meta content="Marco Cella Blog" name="description"><link href="/manifest.json" rel="manifest"><link href="/logo192.png" rel="apple-touch-icon"><title>PostgreSQL Triggers and notify/listen</title><style>@import url(https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap);</style><script type="text/javascript">!function(n){if("/"===n.search[1]){var a=n.search.slice(1).split("&").map(function(n){return n.replace(/~and~/g,"&")}).join("?");window.history.replaceState(null,null,n.pathname.slice(0,-1)+a+n.hash)}}(window.location)</script><link href="https://fonts.googleapis.com" rel="preconnect"><script defer src="/static/js/main.88814732.js"></script><link href="/static/css/main.6284e917.css" rel="stylesheet"><meta content="PostgreSQL Triggers and notify/listen" data-react-helmet="true" name="description"><meta content="postgresql, triggers" data-react-helmet="true" name="keywords"><meta content="Marco Cella" data-react-helmet="true" name="author"><meta content="PostgreSQL Triggers and notify/listen" data-react-helmet="true" property="og:title"><meta content="PostgreSQL Triggers and notify/listen" data-react-helmet="true" property="og:description"><meta content="website" data-react-helmet="true" property="og:type"><link href="https://fonts.gstatic.com" rel="preconnect"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="App"><div class="light"><div><nav class="sticky top-0 bg-gray-custom1 dark:bg-slate-custom3 flex justify-center"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0 flex justify-left header"><div class="my-4"><span class="text-5xl font-extrabold text-gray-900 dark:text-white1 m-2">mc //connected</span></div><div class="line-break"></div><div class="w-full min-w-full"><div class="float-left"><a href="/blog" data-discover="true"><button type="button" class="text-gray-900 focus:outline-none border-none hover:bg-gray-100 focus:bg-gray-100 font-medium rounded-full text-sm lg:text-base px-3 py-1.5 me-2 mb-2 dark:border-gray-100 dark:hover:bg-gray-100 dark:hover:border-gray-100 dark:text-gray-100 hover:dark:text-gray-900 dark:bg-slate-custom2 false">Blog</button></a><a href="/profile" data-discover="true"><button type="button" class="text-gray-900 focus:outline-none border-none hover:bg-gray-100 focus:bg-gray-100 font-medium rounded-full text-sm lg:text-base px-3 py-1.5 me-2 mb-2 dark:border-gray-100 dark:hover:bg-gray-100 dark:hover:border-gray-100 dark:text-gray-100 hover:dark:text-gray-900 dark:bg-slate-custom2 false">Profile</button></a></div><div class="flex float-right h-full items-center text-gray-900 dark:text-gray-100"><button type="button"><svg class="size-5 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></div></div></div></nav></div><div class="flex flex-col items-center content min-h-[calc(100vh-172px)] dark:bg-slate-custom1"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0"><div class="mt-16 mb-4 flex justify-items-start content"><h1 class="font-semibold text-left text-lg lg:text-2xl w-full md:w-full dark:text-gray-custom1">PostgreSQL Triggers and notify/listen</h1><div class="line-break"></div><span class="flex items-center"><svg class="h-6 w-6 stroke-orange-400 mr-2 text-gray-custom3 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-slot="icon"><path d="M6.75 2.994v2.25m10.5-2.25v2.25m-14.252 13.5V7.491a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v11.251m-18 0a2.25 2.25 0 0 0 2.25 2.25h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5m-6.75-6h2.25m-9 2.25h4.5m.002-2.25h.005v.006H12v-.006Zm-.001 4.5h.006v.006h-.006v-.005Zm-2.25.001h.005v.006H9.75v-.006Zm-2.25 0h.005v.005h-.006v-.005Zm6.75-2.247h.005v.005h-.005v-.005Zm0 2.247h.006v.006h-.006v-.006Zm2.25-2.248h.006V15H16.5v-.005Z" stroke-linecap="round" stroke-linejoin="round"></path></svg><time class="text-gray-custom2 text-left text-sm lg:text-base w-full md:w-full dark:text-gray-custom4">May 25, 2025</time></span><div class="line-break"></div><div class="articleBody"><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Change Data Capture (CDC) in PostgreSQL is the process for identifying and tracking changes made to the database in near-real time. This helps ensure that the data is kept synchronised on downstream systems. PostgreSQL supports Change Data Capture using several approaches, including triggers, polling queries, logical replication, and write-ahead logs (WAL). In this article, I will focus on the triggers and notify/listen mechanism.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Triggers in PostgreSQL are used to respond to DML events — INSERT, UPDATE, and DELETE — and are executed on table row changes [1]. The notify/listen mechanism is used to trigger application-level code in response to database events [2]. When combined, these two approaches can form a simple event-driven architecture, enabling applications to receive notifications in near real time.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">I recently worked on a "radar" application that allows devices to send signals about nearby moving objects to a central hub. A Spring WebFlux reactive application connects the frontend web interface to the backend infrastructure via a data stream. This reactive application is a separate backend component from the central hub, specifically tailored for streaming data from the backend to the frontend. One key requirement was for the reactive application to receive near real-time notifications whenever the hub stores a new event.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The GitHub repository of the project is the following:<br><a href="https://github.com/sitMCella/radar" class="underline" rel="noreferrer" target="_blank">sitMCella/radar</a></p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Several considerations influenced my choice of an event-based mechanism: the solution needed to be lightweight with minimal impact on database performance, notifications had to be near real-time, and the reactive application could tolerate occasional missed notifications from the hub.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">In the remainder of this article, I will explain how to configure triggers and the listen/notify mechanism in PostgreSQL, as well as how to integrate it with a Spring WebFlux application.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">First of all create a trigger in the PostgreSQL initialization script. The following is a trigger that responds to INSERT operations on the "signals" table:</p><pre class="mt-4 text-left h-68 w-full language-sql" tabindex="0"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> notify_signals
    <span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span>
    <span class="token keyword">ON</span> signals
    <span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> notify_signals_event<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The function <code>notify_signals_event</code> is defined as:</p><pre class="mt-4 text-left h-68 w-full language-sql" tabindex="0"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> notify_signals_event<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">AS</span>
$$
<span class="token keyword">BEGIN</span>
    PERFORM pg_notify<span class="token punctuation">(</span><span class="token string">'signals_notification'</span><span class="token punctuation">,</span> json_build_object<span class="token punctuation">(</span>
      <span class="token string">'id'</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token string">'creationtime'</span><span class="token punctuation">,</span> to_char<span class="token punctuation">(</span>NEW<span class="token punctuation">.</span>creationtime<span class="token punctuation">,</span> <span class="token string">'YYYY-MM-DD"T"HH24:MI:SS.US"Z"'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'deviceId'</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>device_id<span class="token punctuation">,</span>
      <span class="token string">'objId'</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>obj_id<span class="token punctuation">,</span>
      <span class="token string">'latitude'</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span>
      <span class="token string">'longitude'</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>longitude
    <span class="token punctuation">)</span>::<span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$
<span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span><span class="token punctuation">;</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The <code>pg_notify</code> function takes the channel name as its first argument and a string payload as the second. In the <code>notify_signals_event</code> function, the field "creationtime" is converted from a timestamp to a formatted string before being included in the payload.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Next configure the Spring WebFlux application to listen to the PostgreSQL events. Spring WebFlux uses the r2dbc-postgresql library to connect to the PostgreSQL database.</p><pre class="mt-4 text-left h-96 w-full language-java" tabindex="0"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>r2dbc<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">PostgresqlConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>r2dbc<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@EnableR2dbcRepositories</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SignalService</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PostgresqlConnection</span> connection<span class="token punctuation">;</span>

  <span class="token class-name">SignalService</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token class-name">PostgresqlConnection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@PostConstruct</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postConstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection
      <span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token string">"LISTEN signals_notification"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">PostgresqlResult</span><span class="token operator">::</span><span class="token function">getRowsUpdated</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@PreDestroy</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">preDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">Note that you cannot inject directly the PostgresqlConnection in the service, instead you need to inject the ConnectionFactory and then create the PostgresqlConnection. The service can listen to the PostgreSQL events using:</p><pre class="mt-4 text-left h-68 w-full language-java" tabindex="0"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Signal</span><span class="token punctuation">></span></span> <span class="token function">streamSignals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> connection
    <span class="token punctuation">.</span><span class="token function">getNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onBackpressureBuffer</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> dropped <span class="token operator">-></span> logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Dropped notification: "</span> <span class="token operator">+</span> dropped<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>notification <span class="token operator">-></span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Signal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Cannot send signal"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The backpressure buffer operator controls how buffer overflows are handled when the subscriber cannot keep up with the database notification stream. It helps limit the risk of unhandled events in a reactive application.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">The trigger and listener/notify mechanisms work seamlessly with the Spring WebFlux application, allowing it to handle near real-time events even under heavy load.</p><p class="leading-7 mt-4 text-left text-base lg:text-lg prose dark:prose-dark dark:prose-invert w-full">[1] <a href="https://www.postgresql.org/docs/17/trigger-definition.html" class="underline" rel="noreferrer" target="_blank">Triggers</a><br>[2] <a href="https://www.postgresql.org/docs/17/sql-listen.html" class="underline" rel="noreferrer" target="_blank">Listen</a></p></div></div><div class="mt-8 flex items-center text-left"><svg class="h-5 w-5 stroke-orange-400 mr-1 text-gray-custom3 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-slot="icon"><path d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6 6h.008v.008H6V6Z" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">postgresql</span><span class="m-1 px-1.5 py-0.5 border rounded border-gray-custom3 text-gray-custom2 dark:border-gray-400 dark:text-gray-custom4 text-xs lg:text-sm font-medium text-left text-base prose">triggers</span></div></div><div class="mb-16"></div><div></div></div><div><nav class="sticky top-0 bg-gray-custom1 dark:bg-slate-custom3 flex justify-center"><div class="w-11/12 sm:w-11/12 md:w-9/12 lg:w-8/12 xl:w-6/12 2xl:w-4/12 mx-0 flex justify-left header"><div class="w-full min-w-full"><div class="float-left"><div class="my-4"><span><span class="text-gray-900 dark:text-white1 tracking-wide text-sm lg:text-base">© Marco Cella • all rights reserved</span></span></div></div><div class="flex float-right h-full items-center text-gray-900 dark:text-gray-100"><a href="https://www.linkedin.com/in/marco-cella-48391a5b" class="underline mr-2" rel="noreferrer" target="_blank"><svg class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" stroke-linecap="round" stroke-linejoin="round" width="24"><path d="M0 0h24v24H0z" fill="none" stroke="none"></path><path d="M8 11v5"></path><path d="M8 8v.01"></path><path d="M12 16v-5"></path><path d="M16 16v-3a2 2 0 1 0 -4 0"></path><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z"></path></svg></a><a href="https://mastodon.social/@marco_cella" class="underline" rel="noreferrer" target="_blank"><svg class="icon icon-tabler icons-tabler-outline icon-tabler-brand-mastodon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" stroke-linecap="round" stroke-linejoin="round" width="24"><path d="M0 0h24v24H0z" fill="none" stroke="none"></path><path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z"></path><path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722"></path></svg></a></div></div></div></nav></div></div></div></div></body></html>